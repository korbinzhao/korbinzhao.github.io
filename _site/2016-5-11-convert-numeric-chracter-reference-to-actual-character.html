<p>开发过程中遇到一种奇怪的编码格式: '&#27599;&#26085;&#19968;&#33394;|&#34013;&#30333;~', 使用decode/unescape/decodeURI解码均无效.研究一番,总结一下.</p>

<p>实际上上面这种奇怪的编码格式并不是编码,而是一种叫做 NCR(Numeric Character Reference) 的标记结构.</p>

<h2>Numeric Character Reference</h2>

<p>看看维基百科的解释：</p>

<p>A numeric character reference (NCR) is a common markup construct used in SGML and other SGML-related markup languages such as HTML and XML. It consists of a short sequence of characters that, in turn, represent a single character from the Universal Charact</p>

<p>NCR是一种常见的标记结构，用于SGML和其他SGML相似的标记语言，如HTML和XML。它由一个短的字符序列组成,代表一个字符（全球的文字字符）。</p>

<p>NCR编码是由一个与号(&amp;)跟着一个井号(#), 然后跟着这个字符的Unicode编码值, 最后跟着一个分号组成的, 如:</p>

<pre><code>&amp;#dddd;
&amp;#xhhhh;
&amp;#name;
</code></pre>

<p>其中, dddd是字符编码的十进制表示, 而hhhh是字符的16进制表示.</p>

<p>以 HTML 为例，这三种转义序列都称作 character reference：
前两种是 numeric character reference（NCR），数字取值为目标字符的 Unicode code point；以「&amp;#」开头的后接十进制数字，以「&amp;#x」开头的后接十六进制数字。
后一种是 character entity reference，后接预先定义的 entity 名称，而 entity 声明了自身指代的字符。
从 HTML 4 开始，NCR 以 Unicode 为准，与文档编码无关。</p>

<p>「中国」二字分别是 Unicode 字符 U+4E2D 和 U+56FD，十六进制表示的 code point 数值「4E2D」和「56FD」就是十进制的「20013」和「22269」。所以——</p>

<pre><code>&amp;#x4e2d;&amp;#x56fd;
&amp;#20013;&amp;#22269;
</code></pre>

<p>——这两种 NCR 写法都会在显示时转换为「中国」二字。</p>

<h2>如何将 NCR 字符转换成真实字符</h2>

<p>方法如下:</p>

<pre><code>var regex_num_set = /&amp;#(\d+);/g;
var str = "Here is some text: &amp;#27599;&amp;#26085;&amp;#19968;&amp;#33394;|&amp;#34013;&amp;#30333;~"


str = str.replace(regex_num_set, function(_, $1) {
  return String.fromCharCode($1);
});


document.write('&lt;pre&gt;'+JSON.stringify(str,0,3));
</code></pre>

<p>以上例子使用了 [String.prototype.replace()] 和 String.fromCharCode() 方法. 思路为将字符串中的 NCR 字符逐个获取到 "&amp;#"和";"间的 Unicode 字符编码值, 然后利用 String.fromCharCode() 方法, 将 Unicode 编码转为真实字符.</p>

<h2>参考资料</h2>

<ol>
<li><a href="https://www.zhihu.com/question/21390312">&amp;#x开头的是什么编码呢。浏览器可以解释它。如&#20013;&#22269;等同与中文"中国"?</a></li>
<li><a href="http://stackoverflow.com/questions/35501026/converting-numeric-character-reference-to-actual-character/35501590#35501590">Converting numeric character reference to actual character</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String/replace">String.prototype.replace()</a></li>
<li><a href="http://www.cnblogs.com/shishm/archive/2011/11/24/2261996.html">[字符编码]Numeric Character Reference和HTML Entities（一）</a></li>
</ol>

