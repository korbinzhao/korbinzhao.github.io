<!DOCTYPE html>
<html>
<head>
    <!--
    * Author:         Joebon
    -->
    <meta charset="utf-8" />
    <title>当页面渲染时，浏览器发生了什么 | Joebon's world</title>
    <meta name="author" content="Joebon" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="Joebon's Blog" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>

    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">Joebon</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
        <div class="home-contact">
            <a href="http://weibo.com/zbin1202/" target="_blank" style="margin-left:-5px;"><img src="http://www.weibo.com/favicon.ico" alt="" width="25"/></a>
            <a href="http://www.douban.com/people/korbinzhao/" target="_blank" style="text-align:center;"><img src="http://www.douban.com/favicon.ico" alt="" width="22"/></a>
            <!-- <a href="http://instagram.com/beiyuu/" target="_blank" style="text-align:right"><img src="http://d36xtkk24g8jdx.cloudfront.net/bluebar/00c6602/images/ico/favicon.ico" alt="" width="22"/></a> -->
        </div>
    </div>

    <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/page-render" title="当页面渲染时，浏览器发生了什么">当页面渲染时，浏览器发生了什么</a></h1>
        <p class="entry-date">2016-05-09</p>
        <h2>当页面渲染时，浏览器发生了什么</h2>

<ol>
<li>根据服务器端的 HTML 代码，形成文档对象模型（DOM）</li>
<li>加载并解析样式，形成 CSS 对象模型</li>
<li>在文档对象模型和 CSS 对象模型基础上，生成一颗由一组待生成渲染的对象组成的渲染树</li>
<li>对渲染树上的每个元素，计算其坐标，称之为布局</li>
<li>最后，渲染树上的元素最终展现在浏览器上，称之为“painting”</li>
</ol>


<h2>渲染基础</h2>

<p>首先了解下 Blink 引擎是如何渲染页面的。</p>

<h3>Nodes 和 DOM 树</h3>

<p>在 Blink 引擎中，页面内容是存储为由 Node 对象组成的树状结构，也就是 DOM 树。每一个 HTML element 元素都有一个 Node 对象与之对应，DOM 树的根节点永远都是 Document Node。</p>

<h3>从 Nodes 到 RenderObjects</h3>

<p>DOM 树中的每个 node 节点都有一个对应的 RenderObject 对象。RenderObject 存储在与 DOM 树相应的树形结构中 —— Render Tree。RenderObject 知道如何在屏幕上 paint node 内容，为实现这一操作，RenderObject 会调用其对应的 GraphicsContext 来执行必要的 draw 操作。其中，GraphicsContext 就是负责将像素写入位图（bitmap）中，这些位图最终展示在屏幕中。</p>

<p>PS: draw != paint，draw 是将像素绘制到屏幕上，而 paint 是生成元素呈现的像素。</p>

<h3>从 RenderObjects 到 RenderLayers</h3>

<p>每一个 RenderObject 都直接或间接（通过其父对象）的同一个 RenderLayer 相关联。</p>

<p>RenderLayer 的作用就是保证页面元素以正确的顺序合成（composited），这样才能正确的展现元素的重叠以及半透明元素等等。会有一些情形，为一些特殊的 RenderObjects 创建一个新的 RenderLayer。以下是常见的一定会新建 RenderLayer 的 RnederObject：</p>

<ul>
<li>页面的根节点对应的RenderObject</li>
<li>有明确的 CSS 定位属性（relative、absolute 或者 transform）</li>
<li>是透明的</li>
<li>有 CSS overflow、CSS alpha（遮罩）或者 CSS reflection</li>
<li>有 CSS 滤镜（filter）</li>
<li>canvas 元素对应的 RenderObject</li>
<li>video 元素对应的 RenderObject</li>
</ul>


<p>其他的 RenderObjects 与其最近的拥有 RenderLayer 的父级 RenderObject，拥有同一个 RenderLayer。</p>

<h3>从 RenderLayers 到 GraphicsLayers</h3>

<p>为利用合成器（compositer），满足如下条件的 RenderLayers，会被认为是一个独立的合成层。</p>

<ul>
<li>有 3D 或者 perspective transform 的 CSS 属性的层</li>
<li>video 元素的层</li>
<li>canvas 元素的层</li>
<li>flash</li>
<li>对 opacity 和 transform 对应了 CSS 动画的层</li>
<li>使用了 CSS 滤镜（filters）的层</li>
<li>有合成层后代的层</li>
<li>同合成层重叠，且在该合成层上面（z-index）渲染的层</li>
</ul>


<p>如果 RenderLayer 是一个合成层，那么它有属于自己的单独的 GraphicsLayer，否则它和它最近的又有 GraphicsLayer 的父 layer 共用一个 GraphicsLayer。</p>

<p>每一个GraphicsLayer都有一个GraphicsContext，其对应的RenderLayer会paint进GraphicsContext中。合成器（compositor）最终会负责，将由GraphicsContext输出的位图（bitmap）合并成最终屏幕显示的图案。</p>

<h3>层压缩（Layer Squashing）</h3>

<p>所有的规则都会有漏洞。正如上面提到的，GraphicsLayers会消耗内存和其他资源（随着GraphicsLayer树的大小增长，会使CPU执行时间越来越长）。当一些RenderLayer同一个成为独立合成层的RenderLayer重叠时，就会产生大量的额外的合成层（上节合成层产生条件的最后一条），十分消耗资源。</p>

<p>我们把产生合成层的自身因素（比如有3D变换的层）称之为直接因素，将比如：合成层后代，同合成层重叠等条件成为简介因素。为了防止上述所说的“层爆炸”，当很多element覆盖在因直接因素产生的层之上时，浏览器的排版引擎，会将这些element的RenderLayers覆盖在这个直接因素产生的RenderLayer上，同时将他们压缩（squash）成一个“层”。这就防止了由覆盖引起的层爆炸。更多细节请看这里和这里</p>

<h3>从GraphicsLayers到WebLayers再到CC Layers</h3>

<p>chrome通过WebLayer和cc layer（chrome compositor layer）实现GraphicsLayers。</p>

<h3>小结</h3>

<p>总的来说，为rendering服务的有如下四种树形结构：</p>

<ul>
<li>DOM Tree，基本的模型</li>
<li>RenderObject Tree，同DOM树的可见节点是一一对应的。RenderObject知道如何去paint其相对应的DOM节点</li>
<li>RenderLayer Tree，由RenderLayers组成，这些RenderLayer对应于RenderObject树的RenderObject。这种对应关系是一对多的。</li>
<li>GraphicsLayer Tree，由GraphicsLayers组成，这些GraphicsLayer对应于RenderLayer树的RenderLayer。这种对应关系是一对多的。</li>
</ul>


<p><img src="http://img1.tbcdn.cn/L1/461/1/b611c034f6ea0ad700a1319e52076c64316f21a0" alt="" /></p>

<h2>重绘</h2>

<p>当改变不会影响元素在网页中位置的样式，如 background-color, border-color, visibility 等，浏览器只会用新的样式将元素重绘一遍。</p>

<h2>重排</h2>

<p>当改变影响到文本内容或结构，或者元素位置时，就会发生重排。重排由以下事件触发：</p>

<ul>
<li>DOM 操作（元素的添加、删除、修改、改变顺序）</li>
<li>内容变化，包括表单域内的文本变化</li>
<li>CSS 属性的计算或改变</li>
<li>添加删除样式表</li>
<li>更改“类”的属性</li>
<li>浏览器窗口的操作（缩放、滚动）</li>
<li>伪类激活（:hover 等）</li>
</ul>


<h2>浏览器的优化渲染</h2>

<ul>
<li>浏览器会尽可能的将重绘、重构限制在改变元素的区域内。比如，固定或绝对定位的元素，重绘或重排只会影响元素本身或其子元素，静态定位元素会触发后续所有元素的重流。</li>
<li><p>当 JS 有连续会造成重绘或重排的几段代码时，浏览器会缓存这些改变，在代码运行完毕后再将这些改变一次性应用。举个栗子：</p>

<pre><code>  var $body = $('body');
  $body.css('padding', '1px'); // reflow, repaint
  $body.css('color', 'red'); // repaint
  $body.css('margin', '2px'); // reflow, repaint
  // only 1 reflow and repaint will actually happen
</code></pre>

<p>  以上代码只会触发一次重绘或重排。
  <strong>值得注意的一点，改变元素的属性会触发强制性重排</strong>。如果我们在上面的代码中加入一行访问元素属性的代码，就会引起两次重排。</p>

<pre><code>  var $body = $('body');
  $body.css('padding', '1px');
  $body.css('padding'); // reading a property, a forced  reflow
  $body.css('color', 'red');
  $body.css('margin', '2px');
</code></pre></li>
</ul>


<h2>性能优化的实际意见</h2>

<ul>
<li>尽量减少 DOM 操作。在进行复杂的操作时，最好使用“孤立”的元素（与 DOM 脱离，仅保存在内存中的元素），操作完成后再加入 DOM 中。</li>
<li>改变元素样式时，被操作的元素处于 DOM 渲染树的位置越深越好。</li>
<li>尽量只给位置绝对或者固定定位的元素添加动画元素。</li>
</ul>


<h2>参考文献</h2>

<ol>
<li><a href="http://www.html-js.com/article/3000">有关网页渲染，每个前端开发者都该知道的那点事</a></li>
<li><a href="http://www.chromium.org/developers/design-documents/gpu-accelerated-compositing-in-chrome">GPU Accelerated Compositing in Chrome</a></li>
</ol>



        <!--<div id="disqus_container">-->
            <!--<div style="margin-bottom:20px" class="right">-->
                <!--<script type="text/javascript" charset="utf-8">-->
                <!--(function(){-->
                  <!--var _w = 86 , _h = 16;-->
                  <!--var param = {-->
                    <!--url:location.href,-->
                    <!--type:'6',-->
                    <!--count:'', /**是否显示分享数，1显示(可选)*/-->
                    <!--appkey:'', /**您申请的应用appkey,显示分享来源(可选)*/-->
                    <!--title:'', /**分享的文字内容(可选，默认为所在页面的title)*/-->
                    <!--pic:'', /**分享图片的路径(可选)*/-->
                    <!--ralateUid:'1742737645', /**关联用户的UID，分享微博会@该用户(可选)*/-->
                    <!--language:'zh_cn', /**设置语言，zh_cn|zh_tw(可选)*/-->
                    <!--rnd:new Date().valueOf()-->
                  <!--}-->
                  <!--var temp = [];-->
                  <!--for( var p in param ){-->
                    <!--temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )-->
                  <!--}-->

                  <!--document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'"></iframe>')-->
                <!--})()-->
                <!--</script>-->
            <!--</div>-->
            <!--&lt;!&ndash; <a href="#" class="comment" onclick="return false;">点击查看评论</a> &ndash;&gt;-->
             <!--<div id="disqus_thread"></div>-->
        <!--</div>-->

      <!-- 多说评论框 start -->
      <div class="ds-thread" data-thread-key="/page-render" data-title="当页面渲染时，浏览器发生了什么" data-url="http://joebon.cc/page-render"></div>
      <!-- 多说评论框 end -->
      <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
      <script type="text/javascript">
        var duoshuoQuery = {short_name:"joebon"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
      </script>
      <!-- 多说公共JS代码 end -->

    </div>

    <div class="sidenav">
       <iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=75&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=1742737645&verifier=a3b2e71b&colors=d6f3f7,ffffff,666666,0082cb,ecfbfd&dpc=1"></iframe>
    </div>

    <div class="sidenav">
        <h2>FE</h2>
        <ul class="artical-list">
        
            <li><a href="/performance-optimization">无线性能优化</a></li>
        
            <li><a href="/convert-numeric-chracter-reference-to-actual-character">将 NCR 字符转换为真实字符的方法</a></li>
        
            <li><a href="/page-render">当页面渲染时，浏览器发生了什么</a></li>
        
            <li><a href="/middleware&plugins">nodejs 中间件 & 插件</a></li>
        
            <li><a href="/comparing-escape-encodeURI-and-encodeURIComponent">字符编码扫盲及escape, encodeURI 和 encodeURIComponent方法比较</a></li>
        
            <li><a href="/upload-image-simulate-post-form">模拟form表单上传图片</a></li>
        
            <li><a href="/clipboard-image-upload">剪切板粘贴上传图片功能的实现</a></li>
        
            <li><a href="/date-cross-browser-safari-chrome">Date对象的浏览器兼容性问题</a></li>
        
            <li><a href="/js-scroll-direction">原生JS实现页面滚动方向检测</a></li>
        
            <li><a href="/commonjs-amd-cmd">前端模块化规范 - CommonJS、AMD & CMD</a></li>
        
            <li><a href="/cross-origin-js">JS跨域问题解决方式</a></li>
        
            <li><a href="/mac-os-x-shortcut">Mac OS X 快捷键</a></li>
        
            <li><a href="/nodejs-express-mongodb-website">nodejs+mongdb+express建站学习中所踩得坑</a></li>
        
            <li><a href="/introduction-to-svg">SVG入门</a></li>
        
            <li><a href="/cocos2d-event-dispatcher">Cocos2d-X 3.0 事件分发机制</a></li>
        
        </ul>

        <h2>Product</h2>
        <ul class="artical-list">
        
            <li><a href="/about-life-style">关于生活方式</a></li>
        
            <li><a href="/key-indicator-website-analysis">网站分析指标</a></li>
        
            <li><a href="/become-a-regular-worker">入职了，转正了</a></li>
        
            <li><a href="/about-method">关于方法</a></li>
        
            <li><a href="/about-thinking">关于思考</a></li>
        
        </ul>

        <h2>Life</h2>
        <ul class="artical-list">
        
            <li><a href="/hair-transplant">嗯，植发了</a></li>
        
            <li><a href="/a-meal-with-colleagues">和PD、运营、设计师和用研们的一顿饭</a></li>
        
            <li><a href="/first-douban-activity">第一次豆瓣活动：Coursera公开课之Public Speaking小分队——找回爱交流的自己</a></li>
        
            <li><a href="/restart">平凡之路，重新出发</a></li>
        
        </ul>
    </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>


    <script type="text/javascript">
        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();

                if($('.home-contact').is(':visible')){
                    $('.home-contact').slideUp(100);
                }else{
                    $('.home-contact').slideDown(100);
                }
            });
        })
    </script>

    <!--Google analytics站点统计-->
    <!--https://analytics.google.com/analytics/web/?et&authuser=0#management/Settings/a72552547w110260152p115008802/%3Fm.page%3DTrackingCode%26_r.ghFlowId%3D6324039/-->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-72552547-1', 'auto');
        ga('send', 'pageview');

    </script>
</body>
</html>
